<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>ƒêƒÉng s·∫£n ph·∫©m + Chat (Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Firebase SDK (compat ƒë·ªÉ d√πng nhanh tr√™n 1 file) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; background: #fafafa; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    button { cursor: pointer; padding: 8px 12px; border-radius: 8px; border:1px solid #ddd; background:#fff; }
    button.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; margin: 12px 0; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .col { flex:1 1 320px; }
    input, textarea { width: 100%; padding: 10px; border:1px solid #ddd; border-radius: 8px; }
    label { font-weight: 600; display:block; margin: 8px 0 6px; }
    .muted { color:#666; font-size: 14px; }
    .pill { display:inline-block; background:#f1f5f9; color:#0f172a; padding: 4px 8px; border-radius: 999px; font-size: 12px; }
    .list { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:12px; }
    .hidden { display:none !important; }

    /* Chat panel */
    .chat-panel { position: fixed; right: 16px; bottom: 16px; width: 360px; max-width: calc(100% - 32px);
      background:#fff; border:1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.12); display:flex; flex-direction: column; overflow: hidden; }
    .chat-header { padding:10px 12px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; }
    .chat-messages { padding: 12px; height: 360px; overflow-y: auto; background:#f8fafc; }
    .msg { margin: 6px 0; max-width: 85%; padding: 8px 10px; border-radius: 12px; font-size: 14px; line-height: 1.35; }
    .msg.me { background:#0ea5e9; color:#fff; margin-left:auto; border-bottom-right-radius: 4px; }
    .msg.other { background:#fff; color:#111; border:1px solid #e5e7eb; border-bottom-left-radius: 4px; }
    .chat-input { display:flex; gap:8px; padding: 10px; border-top:1px solid #eee; background:#fff; }
    .chat-input input { flex: 1; }
    .section-title { margin: 20px 0 8px; font-size: 18px; font-weight: 700; }
    .inbox-item { padding:8px 10px; border:1px solid #eee; border-radius:8px; display:flex; align-items:center; justify-content:space-between; margin:6px 0; background:#fff; }
    
    .trade-popup {
        position: fixed; top:0; left:0; right:0; bottom:0;
        background: rgba(0,0,0,0.4);
        display:flex; align-items:center; justify-content:center;
        }
        .trade-form {
        background:#fff; padding:20px; border-radius:12px; width:300px;
        display:flex; flex-direction:column; gap:10px;
        }
        .trade-form input, .trade-form textarea {
        width:100%; padding:8px; border:1px solid #ddd; border-radius:8px;
        }
        .trade-form button { padding:8px; border:none; border-radius:8px; cursor:pointer; }
        .trade-form .primary { background:#0ea5e9; color:#fff; }

  </style>
</head>
<body>
  <header>
    <div>
      <strong>Demo: ƒêƒÉng s·∫£n ph·∫©m + Chat</strong>
      <span id="userInfo" class="muted"></span>
    </div>
    <div>
      <button id="loginBtn" class="primary">ƒêƒÉng nh·∫≠p v·ªõi Google</button>
      <button id="logoutBtn" class="hidden">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>

  <div class="row">
    <div class="col">
      <div class="card">
        <div class="section-title">ƒêƒÉng s·∫£n ph·∫©m</div>
        <div id="postBlock" class="muted">H√£y ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng s·∫£n ph·∫©m.</div>
        <div id="postForm" class="hidden">
          <label for="pname">T√™n s·∫£n ph·∫©m</label>
          <input id="pname" placeholder="V√≠ d·ª•: B√°nh tr√°ng tr·ªôn" />
          <label for="pdesc">M√¥ t·∫£</label>
          <textarea id="pdesc" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt s·∫£n ph·∫©m..."></textarea>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button id="postBtn" class="primary">ƒêƒÉng</button>
            <span class="muted" id="postStatus"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Inbox chat c·ªßa b·∫°n</div>
        <div class="muted">Nh·ªØng ph√≤ng chat c√≥ b·∫°n tham gia (ng∆∞·ªùi b√°n ho·∫∑c ng∆∞·ªùi mua).</div>
        <div id="inboxList"></div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <div class="section-title">Danh s√°ch s·∫£n ph·∫©m</div>
        <div id="products" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Chat panel -->
  <div id="chatPanel" class="chat-panel hidden">
    <div class="chat-header">
      <div>
        <div id="chatTitle" style="font-weight:700;"></div>
        <div id="chatSubtitle" class="muted" style="font-size:12px;"></div>
      </div>
      <button id="closeChatBtn">ƒê√≥ng</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input">
        <input id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
        <button id="sendBtn" class="primary">G·ª≠i</button>
        <button id="tradeBtn" style="background:#facc15; border-color:#facc15;">X√°c nh·∫≠n trade</button>
        </div>
  </div>
  <!-- Popup trade -->
    <div id="tradePopup" class="trade-popup hidden">
    <div class="trade-form">
        <h3>X√°c nh·∫≠n trade</h3>
        <input id="tradeItem" placeholder="T√™n ƒë·ªì trade" />
        <input id="tradeDate" type="date" />
        <textarea id="tradeNote" placeholder="Ghi ch√∫ cho admin"></textarea>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="cancelTrade">H·ªßy</button>
        <button id="submitTrade" class="primary">G·ª≠i</button>
        </div>
    </div>
    </div>


  <script>
    // 1) ƒêi·ªÅn Firebase config c·ªßa b·∫°n v√†o ƒë√¢y
    const firebaseConfig = {
        apiKey: "AIzaSyCbN5xPjSPrVPcjsaexXhkhCwx6xjOYpdg",
        authDomain: "goods-1fb52.firebaseapp.com",
        projectId: "goods-1fb52",
        storageBucket: "goods-1fb52.firebasestorage.app",
        messagingSenderId: "114724287899",
        appId: "1:114724287899:web:b1c0b7b09bfb1667859d3e"
    };


    // 2) Kh·ªüi t·∫°o Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    // 3) DOM
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const postBlock = document.getElementById('postBlock');
    const postForm = document.getElementById('postForm');
    const postBtn = document.getElementById('postBtn');
    const postStatus = document.getElementById('postStatus');
    const productsEl = document.getElementById('products');

    const inboxList = document.getElementById('inboxList');

    const chatPanel = document.getElementById('chatPanel');
    const chatTitle = document.getElementById('chatTitle');
    const chatSubtitle = document.getElementById('chatSubtitle');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const closeChatBtn = document.getElementById('closeChatBtn');

    // 4) State
    let currentUser = null;
    let productsUnsub = null;
    let inboxUnsub = null;
    let messagesUnsub = null;

    // Chat room state
    let activeRoomId = null;
    let activeProduct = null;
    let activeSeller = null; // { uid, name, email }
    let activeParticipants = []; // [sellerId, buyerId]

    // Utility
    function formatTime(ts) {
      const d = ts?.toDate ? ts.toDate() : new Date();
      return d.toLocaleString();
    }
    function byCreatedDesc(a, b) {
      const ta = a.createdAt?.toMillis?.() ?? 0;
      const tb = b.createdAt?.toMillis?.() ?? 0;
      return tb - ta;
    }
    function roomIdFor(productId, sellerId, buyerId) {
      // Ph√≤ng chat duy nh·∫•t theo s·∫£n ph·∫©m + c·∫∑p ng∆∞·ªùi d√πng
      const pair = [sellerId, buyerId].sort().join('_');
      return `prod_${productId}__pair_${pair}`;
    }

    // 5) Auth
    loginBtn.addEventListener('click', async () => {
      try {
        await auth.signInWithPopup(provider);
      } catch (e) {
        alert('ƒêƒÉng nh·∫≠p l·ªói: ' + e.message);
      }
    });
    logoutBtn.addEventListener('click', async () => {
      await auth.signOut();
    });

    auth.onAuthStateChanged((user) => {
      currentUser = user;
      userInfo.textContent = user
        ? ` | Xin ch√†o: ${user.displayName} (${user.email})`
        : '';
      loginBtn.classList.toggle('hidden', !!user);
      logoutBtn.classList.toggle('hidden', !user);
      postBlock.classList.toggle('hidden', !!user);
      postForm.classList.toggle('hidden', !user);
      // Refresh data subscriptions
      subProducts();
      subInbox();
    });

    // 6) ƒêƒÉng s·∫£n ph·∫©m
    postBtn.addEventListener('click', async () => {
      const name = document.getElementById('pname').value.trim();
      const desc = document.getElementById('pdesc').value.trim();
      if (!currentUser) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p.');
      if (!name) return alert('Nh·∫≠p t√™n s·∫£n ph·∫©m.');
      postBtn.disabled = true;
      postStatus.textContent = 'ƒêang ƒëƒÉng...';
      try {
        await db.collection('products').add({
          name, desc,
          sellerId: currentUser.uid,
          sellerName: currentUser.displayName || '',
          sellerEmail: currentUser.email || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('pname').value = '';
        document.getElementById('pdesc').value = '';
        postStatus.textContent = 'ƒê√£ ƒëƒÉng.';
        setTimeout(() => postStatus.textContent = '', 1500);
      } catch (e) {
        alert('L·ªói ƒëƒÉng s·∫£n ph·∫©m: ' + e.message);
      } finally {
        postBtn.disabled = false;
      }
    });

    // 7) Danh s√°ch s·∫£n ph·∫©m realtime
    function subProducts() {
      if (productsUnsub) productsUnsub();
      productsEl.innerHTML = '<div class="muted">ƒêang t·∫£i...</div>';
      productsUnsub = db.collection('products')
        .orderBy('createdAt', 'desc')
        .onSnapshot(snap => {
          const items = [];
          snap.forEach(doc => {
            items.push({ id: doc.id, ...doc.data() });
          });
          renderProducts(items);
        }, err => {
          productsEl.innerHTML = `<div class="muted">L·ªói t·∫£i s·∫£n ph·∫©m: ${err.message}</div>`;
        });
    }

    function renderProducts(items) {
      if (!items.length) {
        productsEl.innerHTML = '<div class="muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.</div>';
        return;
      }
      productsEl.innerHTML = '';
      items.sort(byCreatedDesc).forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        const isSeller = currentUser && p.sellerId === currentUser.uid;
        card.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <div style="font-weight:700;">${p.name || 'Kh√¥ng t√™n'}</div>
            <span class="pill">${isSeller ? 'S·∫£n ph·∫©m c·ªßa b·∫°n' : 'Ng∆∞·ªùi b√°n'}</span>
          </div>
          <div class="muted" style="margin:6px 0 8px;">${p.desc || ''}</div>
          <div class="muted" style="font-size:13px;">Ng∆∞·ªùi b√°n: ${p.sellerName || p.sellerEmail || p.sellerId}</div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            ${(!currentUser || isSeller) ? '' : `<button class="primary" data-chat="${p.id}">Chat v·ªõi ng∆∞·ªùi b√°n</button>`}
          </div>
        `;
        productsEl.appendChild(card);

        // G√°n s·ª± ki·ªán Chat n·∫øu l√† ng∆∞·ªùi mua
        if (currentUser && !isSeller) {
          const btn = card.querySelector('button[data-chat]');
          if (btn) {
            btn.addEventListener('click', () => {
              openChat({
                product: p,
                seller: { uid: p.sellerId, name: p.sellerName || '', email: p.sellerEmail || '' },
                buyer: { uid: currentUser.uid, name: currentUser.displayName || '', email: currentUser.email || '' }
              });
            });
          }
        }
      });
    }

    // 8) Inbox (danh s√°ch ph√≤ng chat c√≥ m√¨nh tham gia)
    function subInbox() {
      if (inboxUnsub) inboxUnsub();
      inboxList.innerHTML = '<div class="muted">ƒêang t·∫£i inbox...</div>';
      if (!currentUser) {
        inboxList.innerHTML = '<div class="muted">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem inbox.</div>';
        return;
      }
      inboxUnsub = db.collection('chats')
        .where('participantIds', 'array-contains', currentUser.uid)
        .orderBy('updatedAt', 'desc')
        .onSnapshot(async (snap) => {
          const chats = [];
          snap.forEach(doc => chats.push({ id: doc.id, ...doc.data() }));
          if (!chats.length) {
            inboxList.innerHTML = '<div class="muted">Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o.</div>';
            return;
          }
          inboxList.innerHTML = '';
          for (const c of chats) {
            const otherId = c.participantIds.find(id => id !== currentUser.uid) || '';
            const lastText = c.lastMessage?.text ? c.lastMessage.text : '(ch∆∞a c√≥ tin nh·∫Øn)';
            const el = document.createElement('div');
            el.className = 'inbox-item';
            el.innerHTML = `
              <div style="min-width:0;">
                <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  ${c.productName || 'S·∫£n ph·∫©m'}
                </div>
                <div class="muted" style="font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  ${lastText}
                </div>
              </div>
              <div style="display:flex; align-items:center; gap:8px;">
                <span class="muted" style="font-size:12px;">${formatTime(c.updatedAt)}</span>
                <button data-open="${c.id}">M·ªü</button>
              </div>
            `;
            inboxList.appendChild(el);

            el.querySelector('button[data-open]').addEventListener('click', async () => {
              // T·∫£i product v√† seller t·ª´ chat doc
              const productId = c.productId;
              const sellerId = c.sellerId;
              const productSnap = await db.collection('products').doc(productId).get();
              const product = { id: productSnap.id, ...productSnap.data() };
              const seller = { uid: sellerId, name: product.sellerName, email: product.sellerEmail };
              const buyerId = currentUser.uid === sellerId ? (otherId || currentUser.uid) : currentUser.uid;
              openChat({
                product,
                seller,
                buyer: { uid: buyerId, name: '', email: '' }, // t√™n buyer kh√¥ng c·∫ßn thi·∫øt ƒë·ªÉ m·ªü ph√≤ng
              });
            });
          }
        }, (err) => {
          inboxList.innerHTML = `<div class="muted">L·ªói inbox: ${err.message}</div>`;
        });
    }

    // 9) M·ªü chat
    async function openChat({ product, seller, buyer }) {
      if (!currentUser) return alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ chat.');
      const isBuyer = currentUser.uid !== seller.uid;
      const buyerId = isBuyer ? currentUser.uid : buyer.uid;
      const roomId = roomIdFor(product.id, seller.uid, buyerId);

      activeRoomId = roomId;
      activeProduct = product;
      activeSeller = seller;
      activeParticipants = [seller.uid, buyerId];

      chatTitle.textContent = product.name || 'S·∫£n ph·∫©m';
      chatSubtitle.textContent = `V·ªõi ng∆∞·ªùi b√°n: ${seller.name || seller.email || seller.uid}`;
      chatPanel.classList.remove('hidden');
      chatMessages.innerHTML = '<div class="muted">ƒêang t·∫£i tin nh·∫Øn...</div>';

      // T·∫°o chat doc n·∫øu ch∆∞a c√≥
      const chatRef = db.collection('chats').doc(roomId);
      const chatDoc = await chatRef.get();
      if (!chatDoc.exists) {
        await chatRef.set({
          productId: product.id,
          productName: product.name || '',
          sellerId: seller.uid,
          participantIds: [seller.uid, buyerId],
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastMessage: null
        }, { merge: true });
      }

      // Subscribe messages
      if (messagesUnsub) messagesUnsub();
      messagesUnsub = db.collection('chats').doc(roomId)
        .collection('messages')
        .orderBy('createdAt', 'asc')
        .onSnapshot(snap => {
          chatMessages.innerHTML = '';
          snap.forEach(doc => {
            const m = doc.data();
            const mine = m.senderId === (currentUser?.uid || '');
            const div = document.createElement('div');

            if (m.type === 'trade') {
                div.className = `msg ${mine ? 'me' : 'other'}`;
                div.style.background = '#fef9c3';
                div.style.color = '#78350f';
                div.innerHTML = `
                    <div>üì¶ <strong>Trade ƒë·ªÅ xu·∫•t</strong></div>
                    <div>ƒê·ªì: ${escapeHtml(m.tradeInfo.item)}</div>
                    <div>Ng√†y giao: ${escapeHtml(m.tradeInfo.date)}</div>
                    <div>Ghi ch√∫: ${escapeHtml(m.tradeInfo.note || '')}</div>
                    <div class="muted" style="font-size:11px; margin-top:4px;">
                    ${m.senderName || ''} ‚Ä¢ ${formatTime(m.createdAt)}
                    </div>
                `;
            } else {
                // Tin nh·∫Øn th∆∞·ªùng
                div.className = `msg ${mine ? 'me' : 'other'}`;
                div.innerHTML = `
                <div>${escapeHtml(m.text || '')}</div>
                <div class="muted" style="font-size:11px; margin-top:4px;">
                    ${m.senderName || ''} ‚Ä¢ ${formatTime(m.createdAt)}
                </div>
                `;
            }

            chatMessages.appendChild(div);
            });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }, err => {
          chatMessages.innerHTML = `<div class="muted">L·ªói t·∫£i tin nh·∫Øn: ${err.message}</div>`;
        });
    }

    // 10) G·ª≠i tin nh·∫Øn
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      if (!currentUser || !activeRoomId) return;
      chatInput.value = '';
      const msgRef = db.collection('chats').doc(activeRoomId).collection('messages').doc();
      const payload = {
        text,
        senderId: currentUser.uid,
        senderName: currentUser.displayName || currentUser.email || '·∫®n danh',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const chatRef = db.collection('chats').doc(activeRoomId);
      const batch = db.batch();
      batch.set(msgRef, payload);
      batch.set(chatRef, {
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastMessage: { text, at: firebase.firestore.FieldValue.serverTimestamp(), senderId: currentUser.uid }
      }, { merge: true });
      try {
        await batch.commit();
      } catch (e) {
        alert('G·ª≠i tin nh·∫Øn l·ªói: ' + e.message);
      }
    }

    closeChatBtn.addEventListener('click', () => {
      chatPanel.classList.add('hidden');
      if (messagesUnsub) messagesUnsub();
      messagesUnsub = null;
      activeRoomId = null;
      activeProduct = null;
      activeSeller = null;
      activeParticipants = [];
    });

    // 11) XSS-safe render
    function escapeHtml(str) {
      return (str || '').replace(/[&<>"']/g, function(m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
      });
    }

    // 12) Trade ƒë·ªì
    const tradeBtn = document.getElementById('tradeBtn');
    const tradePopup = document.getElementById('tradePopup');
    const tradeItem = document.getElementById('tradeItem');
    const tradeDate = document.getElementById('tradeDate');
    const tradeNote = document.getElementById('tradeNote');
    const cancelTrade = document.getElementById('cancelTrade');
    const submitTrade = document.getElementById('submitTrade');

    tradeBtn.addEventListener('click', () => {
        if (!currentUser || !activeRoomId) {
            alert('B·∫°n c·∫ßn m·ªü ph√≤ng chat ƒë·ªÉ x√°c nh·∫≠n trade.');
            return;
        }
        tradeItem.value = '';
        tradeDate.value = '';
        tradeNote.value = '';
        tradePopup.classList.remove('hidden');
    });

    cancelTrade.addEventListener('click', () => {
        tradePopup.classList.add('hidden');
    });

    submitTrade.addEventListener('click', async () => {
        const item = tradeItem.value.trim();
        const date = tradeDate.value;
        const note = tradeNote.value.trim();
        if (!item || !date) {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒë·ªì v√† ng√†y giao.');
            return;
        }
        await sendTradeMessage({ item, date, note });
        tradePopup.classList.add('hidden');
        });


    // G·ª≠i tin nh·∫Øn trade
    async function sendTradeMessage({ item, date, note }) {
        const chatRef = db.collection('chats').doc(activeRoomId);
        const msgRef = chatRef.collection('messages').doc();

        const payload = {
            type: 'trade',
            tradeInfo: { item, date, note },
            senderId: currentUser.uid,
            senderName: currentUser.displayName || currentUser.email || '·∫®n danh',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const chatSnap = await chatRef.get();
        const chatData = chatSnap.data() || {};
        const tradeConfirmations = chatData.tradeConfirmations || {};
        tradeConfirmations[currentUser.uid] = payload.tradeInfo;

        const batch = db.batch();
        batch.set(msgRef, payload);
        batch.set(chatRef, {
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastMessage: { text: `[TRADE] ${item} - ${date}`, at: firebase.firestore.FieldValue.serverTimestamp(), senderId: currentUser.uid },
            tradeConfirmations
        }, { merge: true });

        const sellerId = chatData.sellerId;
        const buyerId = chatData.participantIds?.find(id => id !== sellerId);

        // N·∫øu ch∆∞a c√≥ transaction ‚Üí t·∫°o m·ªõi
        let transactionRef;
        if (!chatData.transactionId) {
            transactionRef = db.collection('transactions').doc();
            batch.set(transactionRef, {
            productId: chatData.productId,
            productName: chatData.productName,
            sellerId,
            buyerId,
            sellerTradeInfo: tradeConfirmations[sellerId] || null,
            buyerTradeInfo: tradeConfirmations[buyerId] || null,
            status: "pending",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // L∆∞u transactionId v√†o chat ƒë·ªÉ l·∫ßn sau update
            batch.set(chatRef, { transactionId: transactionRef.id }, { merge: true });
        } else {
            transactionRef = db.collection('transactions').doc(chatData.transactionId);
            batch.set(transactionRef, {
            sellerTradeInfo: tradeConfirmations[sellerId] || null,
            buyerTradeInfo: tradeConfirmations[buyerId] || null
            }, { merge: true });
        }

        // N·∫øu c·∫£ 2 b√™n ƒë√£ x√°c nh·∫≠n ‚Üí ho√†n t·∫•t
        if (Object.keys(tradeConfirmations).length === 2) {
            batch.set(chatRef, { tradeCompleted: true }, { merge: true });
            batch.set(transactionRef, { status: "completed" }, { merge: true });
        }

        try {
            await batch.commit();
        } catch (e) {
            alert('G·ª≠i trade l·ªói: ' + e.message);
        }
        }


  </script>
</body>
</html>
